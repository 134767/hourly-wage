<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>時薪人員特休時數計算</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 40px 20px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 90%;
      max-width: 900px;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.07);
    }

    h1 {
      text-align: center;
      font-size: 32px;
      margin-bottom: 20px;
      color: #333;
    }
    h2 {
      font-size: 22px;
      margin-top: 30px;
      color: #444;
    }
    h3 {
      font-size: 18px;
      margin-top: 16px;
      margin-bottom: 8px;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      font-size: 16px;
    }
    th {
      background: #f0f0f0;
    }

    input, select {
      padding: 6px;
      font-size: 16px;
      width: 90%;
    }

    .btn {
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px 5px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      transition: 0.2s;
    }
    .btn-add {
      background: #4caf50;
      color: white;
    }
    .btn-add:hover {
      background: #45a049;
    }
    .btn-calc {
      background: #2196f3;
      color: white;
    }
    .btn-calc:hover {
      background: #1976d2;
    }
    .btn-export {
      background: #ff9800;
      color: white;
    }
    .btn-export:hover {
      background: #fb8c00;
    }
    .btn-del-row {
      background: #e11d48;
      color: #fff;
      padding: 4px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .btn-del-row:hover {
      background: #be123c;
    }

    #resultArea {
      white-space: pre-wrap;
      font-size: 18px;
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 20px;
      line-height: 1.6;
    }

    label {
      font-size: 18px;
    }

    .hire-row {
      margin-bottom: 10px;
    }
    .hire-select {
      width: auto;
      min-width: 80px;
      margin-left: 6px;
      margin-right: 6px;
    }

    .info-text {
      font-size: 16px;
      line-height: 1.8;
      color: #444;
    }
    .info-text ul {
      padding-left: 20px;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .info-text li {
      margin-bottom: 4px;
    }

    .small-note {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
  </style>
  <!-- 匯出 xlsx 用的 SheetJS（純前端） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">

  <h1>時薪人員特休時數計算</h1>

  <div class="hire-row">
    <label>
      學號（選填）：
      <input type="text" id="studentId" style="width:200px;">
    </label>
  </div>

  <div class="hire-row">
    <label>
      到職日（第一次聘用的時間，選填）：
      <select id="hireYear" class="hire-select">
        <option value="">年份</option>
      </select>
      年
      <select id="hireMonth" class="hire-select">
        <option value="">月份</option>
        <option value="01">1</option>
        <option value="02">2</option>
        <option value="03">3</option>
        <option value="04">4</option>
        <option value="05">5</option>
        <option value="06">6</option>
        <option value="07">7</option>
        <option value="08">8</option>
        <option value="09">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
      月
      <!-- 日固定為 1 號，不顯示在畫面上 -->
      <input type="hidden" id="hireDay" value="01">
    </label>
    <div class="small-note">
      ※ 若有填入到職日，年資級距將以到職日起算；未填入則以第一筆有登記工時之年月作為起算月。<br>
      ※ 月份中間若有空白（未填任何工時資料）則不列入年資月份。
    </div>
  </div>

  <h2>每月工時登記</h2>
  <table>
    <thead>
      <tr>
        <th>年</th>
        <th>月</th>
        <th>當月工時（小時）</th>
        <th>刪除</th>
      </tr>
    </thead>
    <tbody id="rowsBody"></tbody>
  </table>

  <button class="btn btn-add" id="btnAddRow">＋ 新增下一筆資料</button>
  <button class="btn btn-calc" id="btnCalc">開始計算</button>
  <button class="btn btn-export" id="btnExport">匯出 Excel</button>

  <h2>計算結果</h2>
  <pre id="resultArea">尚未計算</pre>

  <!-- ========= 相關資料區塊 ========= -->
  <h2>相關資料</h2>

  <h3>勞工的特別休假該如何排定？天數該怎麼計算？</h3>
  <div class="info-text">
    <p>
      特別休假期日，由勞工排定之。但雇主基於企業經營上之急迫需求或勞工因個人因素，得與他方協商調整。
    </p>
    <p>勞工在同一雇主或事業單位，繼續工作滿一定期間者，應依下列規定給予特別休假：</p>
    <ul>
      <li>一、6個月以上1年未滿者，3日。</li>
      <li>二、1年以上2年未滿者，7日。</li>
      <li>三、2年以上3年未滿者，10日。</li>
      <li>四、3年以上5年未滿者，每年14日。</li>
      <li>五、5年以上10年未滿者，每年15日。</li>
      <li>六、10年以上者，每1年加給1日，加至30日為止。</li>
    </ul>
  </div>

  <h3>公式來源：人事室</h3>
  <div class="info-text">
    <p>
      工讀生年度休假須依工作時數與勞基法規定依比例結算給同學，請務必留預算並定期結算給予。<br>
      （僱用部分時間工作勞工應行注意事項）計算參考如下：
    </p>
    <p>一年工作時數為 2088 小時，每日以 8 小時為計：</p>
    <ul>
      <li>到職 6 個月：總工時 ÷ 1044 × 8 × 法定年休假 3 日 = 部分工時休假</li>
      <li>到職第 2 年：總工時 ÷ 2088 × 8 × 法定年休假 7 日 = 部分工時休假</li>
      <li>到職第 3 年：總工時 ÷ 2088 × 8 × 法定年休假 10 日 = 部分工時休假</li>
      <li>到職第 4、5 年：總工時 ÷ 2088 × 8 × 法定年休假 14 日 = 部分工時休假</li>
    </ul>
  </div>

</div>

<script>
  const rowsBody       = document.getElementById('rowsBody');
  const btnAddRow      = document.getElementById('btnAddRow');
  const btnCalc        = document.getElementById('btnCalc');
  const btnExport      = document.getElementById('btnExport');
  const resultArea     = document.getElementById('resultArea');
  const hireYearSelect = document.getElementById('hireYear');
  const hireMonthSelect= document.getElementById('hireMonth');
  const hireDayHidden  = document.getElementById('hireDay');
  const studentIdInput = document.getElementById('studentId');

  // ===== 初始化「到職年份」下拉選單 =====
  (function initHireYearOptions() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const startYear = currentYear - 20;
    const endYear = currentYear + 5;

    for (let y = startYear; y <= endYear; y++) {
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = y;
      hireYearSelect.appendChild(opt);
    }
  })();

  // ===== 工具 =====
  function fmtDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  // ===== 生成一列輸入列（含刪除鍵） =====
  function addRow(defaultYear, defaultMonth) {
    const tr = document.createElement('tr');

    const tdYear = document.createElement('td');
    const inputYear = document.createElement('input');
    inputYear.type = 'number';
    inputYear.min = '1900';
    inputYear.max = '2100';
    inputYear.name = 'year';
    if (defaultYear) inputYear.value = defaultYear;
    tdYear.appendChild(inputYear);

    const tdMonth = document.createElement('td');
    const selectMonth = document.createElement('select');
    selectMonth.name = 'month';
    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement('option');
      opt.value = String(m).padStart(2, '0');
      opt.textContent = m;
      selectMonth.appendChild(opt);
    }
    if (defaultMonth) {
      selectMonth.value = String(defaultMonth).padStart(2, '0');
    }
    tdMonth.appendChild(selectMonth);

    const tdHours = document.createElement('td');
    const inputHours = document.createElement('input');
    inputHours.type = 'number';
    inputHours.min = '0';
    inputHours.step = '0.1';
    inputHours.name = 'hours';
    tdHours.appendChild(inputHours);

    const tdDel = document.createElement('td');
    const btnDel = document.createElement('button');
    btnDel.type = 'button';
    btnDel.textContent = '刪除';
    btnDel.className = 'btn-del-row';
    btnDel.addEventListener('click', function () {
      if (rowsBody.querySelectorAll('tr').length <= 1) {
        alert('至少需保留一列資料。');
        return;
      }
      tr.remove();
    });
    tdDel.appendChild(btnDel);

    tr.appendChild(tdYear);
    tr.appendChild(tdMonth);
    tr.appendChild(tdHours);
    tr.appendChild(tdDel);

    rowsBody.appendChild(tr);
  }

  // 初始：先加一列，年/月抓今天
  (function initFirstRow() {
    const today = new Date();
    addRow(today.getFullYear(), today.getMonth() + 1);
  })();

  // 新增一列：自動上一列 +1 個月
  btnAddRow.addEventListener('click', function () {
    const trs = rowsBody.querySelectorAll('tr');
    let nextYear, nextMonth;

    if (trs.length > 0) {
      const lastTr = trs[trs.length - 1];
      const lastYearVal = lastTr.querySelector('input[name="year"]').value;
      const lastMonthVal = lastTr.querySelector('select[name="month"]').value;

      let y = Number(lastYearVal);
      let m = Number(lastMonthVal);

      if (!y || !m) {
        const today = new Date();
        nextYear = today.getFullYear();
        nextMonth = today.getMonth() + 1;
      } else {
        m += 1;
        if (m > 12) { m = 1; y += 1; }
        nextYear = y;
        nextMonth = m;
      }
    } else {
      const today = new Date();
      nextYear = today.getFullYear();
      nextMonth = today.getMonth() + 1;
    }

    addRow(nextYear, nextMonth);
  });

  // Enter / Tab 直接跳到下一列工時
  rowsBody.addEventListener('keydown', function (e) {
    if (e.key !== 'Enter' && e.key !== 'Tab') return;
    if (e.shiftKey) return;

    const target = e.target;
    if (!(target instanceof HTMLInputElement || target instanceof HTMLSelectElement)) return;

    const tr = target.closest('tr');
    if (!tr) return;

    const rows = Array.from(rowsBody.querySelectorAll('tr'));
    const idx = rows.indexOf(tr);
    if (idx === -1) return;

    e.preventDefault();

    if (idx < rows.length - 1) {
      const nextTr = rows[idx + 1];
      const nextHours = nextTr.querySelector('input[name="hours"]');
      if (nextHours) nextHours.focus();
    } else {
      btnAddRow.click();
      const newRows = rowsBody.querySelectorAll('tr');
      const lastTr = newRows[newRows.length - 1];
      const lastHours = lastTr.querySelector('input[name="hours"]');
      if (lastHours) lastHours.focus();
    }
  });

  // ===== 讀取並驗證每列資料 =====
  function getRowsOrAlert() {
    const trs = rowsBody.querySelectorAll('tr');
    const rows = [];
    let rowIndex = 0;

    for (const tr of trs) {
      rowIndex++;
      const yearStr  = tr.querySelector('input[name="year"]').value.trim();
      const monthStr = tr.querySelector('select[name="month"]').value.trim();
      const hoursStr = tr.querySelector('input[name="hours"]').value.trim();

      // 若整列完全空白，就跳過
      if (!yearStr && !monthStr && !hoursStr) continue;

      if (!yearStr || !monthStr) {
        alert(`第 ${rowIndex} 列年或月未填寫，請補上。`);
        return null;
      }

      const y = Number(yearStr);
      const m = Number(monthStr);
      if (!y || isNaN(y) || m < 1 || m > 12) {
        alert(`第 ${rowIndex} 列年/月格式錯誤，請重新輸入。`);
        return null;
      }

      if (hoursStr === "" || isNaN(Number(hoursStr))) {
        alert(`第 ${rowIndex} 列當月工時非數字，請重新輸入。`);
        return null;
      }
      const h = Number(hoursStr);

      rows.push({ year: y, month: m, hours: h });
    }

    if (!rows.length) {
      alert('請至少新增一列有效的資料');
      return null;
    }

    return rows;
  }

  // ===== 勞基法級距（以「有效月份數」當作年資月份） =====
  const LAW_LEVELS = [
    { min:  6, max: 11, days:  3, label: "6個月以上1年未滿" },
    { min: 12, max: 23, days:  7, label: "1年以上2年未滿" },
    { min: 24, max: 35, days: 10, label: "2年以上3年未滿" },
    { min: 36, max: 59, days: 14, label: "3年以上5年未滿" },
    { min: 60, max:119, days: 15, label: "5年以上10年未滿" }
    // 120 個月（10 年）以上另外處理
  ];

  // ===== 計算按鈕 =====
  btnCalc.addEventListener('click', function () {
    const rows = getRowsOrAlert();
    if (!rows) return;

    const hireYear  = hireYearSelect.value;
    const hireMonth = hireMonthSelect.value;
    const hireDay   = hireDayHidden.value || "01";

    // 工時 + 月份統計
    let totalHours = 0;
    let minDate = null;
    let maxDate = null;

    const monthMap = new Map(); // key: "yyyy-mm" -> {year, month, date}

    rows.forEach(r => {
      const d = new Date(r.year, r.month - 1, 1);
      totalHours += r.hours;

      if (!minDate || d < minDate) minDate = d;
      if (!maxDate || d > maxDate) maxDate = d;

      const key = `${r.year}-${String(r.month).padStart(2,'0')}`;
      if (!monthMap.has(key)) {
        monthMap.set(key, { year: r.year, month: r.month, date: d });
      }
    });

    const monthsAll = Array.from(monthMap.values()).sort((a, b) => a.date - b.date);
    if (!monthsAll.length) {
      resultArea.textContent = '年月資料有誤，請確認年/月欄位';
      return;
    }

    // 基準起算日：有填到職日 → 到職日；未填 → 第一筆工時所在年月
    let baseDate;
    let baseText;
    if (hireYear && hireMonth) {
      baseDate = new Date(`${hireYear}-${hireMonth}-${hireDay}`);
      if (isNaN(baseDate.getTime())) {
        resultArea.textContent = '到職年月格式錯誤，無法計算特休。';
        return;
      }
      baseText = fmtDate(baseDate) + '（依到職日起算）';
    } else {
      baseDate = monthsAll[0].date;
      baseText = fmtDate(baseDate) + '（未填到職日，改以第一筆工時年月起算）';
    }

    // 只留下「基準日起之後」有登記的月份
    const monthsFiltered = monthsAll.filter(m => m.date >= baseDate);
    const serviceMonths = monthsFiltered.length;

    const lawYears = Math.floor(serviceMonths / 12);
    const lawMonthsRemainder = serviceMonths % 12;

    const HOURS_PER_DAY = 8;

    let output = "";

    // 一、年資與法定特休（用「有效月份數」折算）
    output += `一、年資與法定特休\n`;
    output += `學號：${studentIdInput.value ? studentIdInput.value : '（未填寫）'}\n`;
    output += `年資起算基準：${baseText}\n`;
    output += `實際有登記之有效月份數：${serviceMonths} 個月（含工時 0）\n`;
    output += `折算年資：約 ${lawYears} 年 ${lawMonthsRemainder} 個月（以有效月份數計）\n`;

    let lawDetailLines = [];
    let totalLawDays = 0;

    if (serviceMonths < 6) {
      lawDetailLines.push("目前有效月份未滿 6 個月，尚無法定特別休假日數。");
    } else {
      LAW_LEVELS.forEach(stage => {
        if (serviceMonths >= stage.min) {
          const startIdx = stage.min - 1;
          const endIdx = Math.min(serviceMonths, stage.max + 1) - 1;
          if (startIdx < monthsFiltered.length && endIdx < monthsFiltered.length) {
            const s = monthsFiltered[startIdx];
            const e = monthsFiltered[endIdx];
            const periodText =
              `${s.year}/${String(s.month).padStart(2,'0')} ~ ` +
              `${e.year}/${String(e.month).padStart(2,'0')}`;
            lawDetailLines.push(`${stage.label}\t${periodText}\t${stage.days} 日`);
            totalLawDays += stage.days;
          }
        }
      });

      // 10 年以上（serviceMonths >= 120）
      if (serviceMonths >= 120) {
        const yearsOverTen = Math.floor(serviceMonths / 12) - 10;
        const days = Math.min(15 + yearsOverTen, 30);
        const startIdx = 120 - 1;
        const endIdx = serviceMonths - 1;
        if (startIdx < monthsFiltered.length && endIdx < monthsFiltered.length) {
          const s = monthsFiltered[startIdx];
          const e = monthsFiltered[endIdx];
          const periodText =
            `${s.year}/${String(s.month).padStart(2,'0')} ~ ` +
            `${e.year}/${String(e.month).padStart(2,'0')}`;
          lawDetailLines.push(`10年以上（每年加給1日，加至30日）\t${periodText}\t${days} 日`);
          totalLawDays += days;
        }
      }
    }

    output += `\n依勞基法第 38 條，目前已涵蓋之特休級距如下（以有效月份換算）：\n\n`;
    if (lawDetailLines.length === 1 && serviceMonths < 6) {
      output += lawDetailLines[0] + "\n";
    } else {
      output += `級距\t對應期間（以實際有登記之年月為示意）\t每年特休日數\n`;
      lawDetailLines.forEach(line => { output += line + "\n"; });
      output += `\n若將上述各級距單純加總，示意特休日數：${totalLawDays} 日；\n`;
      output += `若以每天 ${HOURS_PER_DAY} 小時計，合計約 ${ (totalLawDays * HOURS_PER_DAY).toFixed(2) } 小時（僅作級距示意）。\n`;
    }

    // 二、工時資料統計
    const periodEnd = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);
    output += `\n二、工時資料統計\n`;
    output += `工時資料期間（有登記工時）：${fmtDate(minDate)} ~ ${fmtDate(periodEnd)}\n`;
    output += `共有月份筆數（實際填入的年月列數）：${rows.length} 列\n`;
    output += `有效月份數（用於年資計算）：${serviceMonths} 個月\n`;
    output += `全部登記工時總和：約 ${totalHours} 小時\n`;

    // 三、依人事室公式換算特休時數（部分工時）
    const FULL_YEAR = 2088;
    const HALF_YEAR = 1044;
    const leaveStages = [
      { min:  6, max: 11,  days:  3, hoursBase: HALF_YEAR, label: "6個月以上1年未滿（3日）" },
      { min: 12, max: 23,  days:  7, hoursBase: FULL_YEAR, label: "1年以上2年未滿（7日）" },
      { min: 24, max: 35,  days: 10, hoursBase: FULL_YEAR, label: "2年以上3年未滿（10日）" },
      { min: 36, max: 59,  days: 14, hoursBase: FULL_YEAR, label: "3年以上5年未滿（14日）" }
      // 5 年以上後面的級距如有需要可再補
    ];

    let totalLeaveHours = 0;
    let leaveDetailText = "";

    leaveStages.forEach(stage => {
      if (serviceMonths >= stage.min) {
        const startIdx = stage.min - 1;
        const endIdx = Math.min(serviceMonths, stage.max + 1) - 1;
        if (startIdx < monthsFiltered.length && endIdx < monthsFiltered.length) {
          const s = monthsFiltered[startIdx];
          const e = monthsFiltered[endIdx];
          const period =
            `${s.year}/${String(s.month).padStart(2,'0')} - ` +
            `${e.year}/${String(e.month).padStart(2,'0')}`;
          const leaveHours = totalHours / stage.hoursBase * HOURS_PER_DAY * stage.days;
          totalLeaveHours += leaveHours;
          leaveDetailText += `${stage.label}：\n(${period})\n${leaveHours.toFixed(2)} 小時\n\n`;
        }
      }
    });

    output += `\n三、依人事室公式換算部分工時特休\n`;
    if (totalLeaveHours === 0) {
      output += `目前有效月份未達 6 個月，尚無可換算之特休時數。\n`;
    } else {
      output += `全部總和特休時數：約 ${totalLeaveHours.toFixed(2)} 小時\n`;
      output += leaveDetailText;
    }

    output += `※ 上述計算僅供內部試算參考，實際給假仍以單位規定與人事室認定為準。\n`;

    resultArea.textContent = output;
  });

  // ===== 匯出 Excel =====
  btnExport.addEventListener('click', function () {
    const rows = getRowsOrAlert();
    if (!rows) return;

    const hireYear  = hireYearSelect.value;
    const hireMonth = hireMonthSelect.value;

    const aoa = [];
    // 學號
    aoa.push(['學號', studentIdInput.value || '未填寫']);
    // 到職資訊
    let hireText = '未填寫';
    if (hireYear && hireMonth) {
      hireText = `${hireYear}-${hireMonth}（系統預設為每月1日）`;
    }
    aoa.push(['到職年月', hireText]);
    aoa.push([]);

    // 工時表
    aoa.push(['年', '月', '當月工時（小時）']);
    rows.forEach(r => {
      aoa.push([r.year, String(r.month).padStart(2,'0'), r.hours]);
    });

    // 計算結果
    aoa.push([]);
    aoa.push(['--- 計算結果 ---']);
    const resultText = resultArea.textContent || '';
    resultText.split('\n').forEach(line => {
      aoa.push([line]);
    });

    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '工時與結果');

    const fileName = '時薪人員特休時數計算.xlsx';
    XLSX.writeFile(wb, fileName);
  });
</script>

</body>
</html>
