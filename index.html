<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>時薪人員特休計算系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 匯出 Excel 用的 SheetJS（前端生成 .xlsx） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .app-shell {
      max-width: 1100px;
      width: 100%;
      background: #020617;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
    }
    h1, h2, h3 {
      margin: 0 0 12px;
      font-weight: 600;
    }
    h1 { font-size: 24px; color: #fbbf24; display: flex; align-items: center; gap: 8px; }
    h1 span.badge {
      font-size: 11px;
      background: #1d4ed8;
      padding: 2px 8px;
      border-radius: 999px;
      color: #e5e7eb;
    }
    p { margin: 4px 0 8px; font-size: 13px; color: #9ca3af; }

    label { font-size: 13px; color: #e5e7eb; display: block; margin-bottom: 4px; }
    input, select, button {
      font-family: inherit;
      font-size: 14px;
    }
    input[type="text"], input[type="password"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.4);
    }
    button {
      border-radius: 999px;
      padding: 6px 14px;
      border: none;
      cursor: pointer;
      background: #f59e0b;
      color: #111827;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    button.danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .col {
      flex: 1;
      min-width: 160px;
    }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }

    .section {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 16px 16px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), #020617);
      margin-top: 12px;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .section-header h2 {
      font-size: 16px;
      color: #e5e7eb;
    }

    /* Login view */
    #login-view {
      display: block;
    }
    #app-view {
      display: none;
    }
    .login-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 16px;
    }
    @media (max-width: 800px) {
      .login-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 14px 14px;
      background: linear-gradient(145deg, #020617, #020617);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header h3 {
      font-size: 15px;
      color: #e5e7eb;
    }
    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #1f2937;
      color: #9ca3af;
    }

    /* 圖形鎖 */
    .pattern-lock {
      width: 180px;
      height: 180px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      margin: 8px auto 4px;
      touch-action: none;
    }
    .pattern-node {
      border-radius: 999px;
      border: 2px solid #4b5563;
      background: radial-gradient(circle at 30% 30%, #111827, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 13px;
      user-select: none;
    }
    .pattern-node.active {
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.4);
      color: #fef3c7;
    }
    .tiny {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
    .status {
      font-size: 12px;
      margin-top: 4px;
    }
    .status.ok { color: #4ade80; }
    .status.warn { color: #facc15; }
    .status.error { color: #f87171; }

    /* Hours table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }
    thead {
      background: #020617;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #e5e7eb;
      cursor: pointer;
      user-select: none;
    }
    tbody tr:nth-child(even) {
      background: #020617;
    }
    tbody tr:nth-child(odd) {
      background: #020617;
    }
    .btn-icon {
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* Result */
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .pill {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 12px;
    }
    .pill-label {
      color: #9ca3af;
      margin-bottom: 2px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <h1>
      時薪人員特休計算系統
      <span class="badge">GitHub Pages 版本</span>
    </h1>
    <p>※ 此版本為前端樣板，帳號鎖定 / 圖形鎖 / IP 鎖等資安機制請搭配後端實作。</p>

    <!-- ========== Login View ========== -->
    <div id="login-view">
      <div class="login-grid mt-12">
        <!-- 帳號 / 密碼 -->
        <div class="card">
          <div class="card-header">
            <h3>登入驗證</h3>
            <span class="tag">帳號＋密碼</span>
          </div>
          <div class="row">
            <div class="col">
              <label for="login-account">帳號</label>
              <input type="text" id="login-account" placeholder="例如：staff01" autocomplete="username" />
            </div>
            <div class="col">
              <label for="login-password">密碼</label>
              <input type="password" id="login-password" placeholder="請輸入密碼" autocomplete="current-password" />
            </div>
          </div>
          <p class="tiny mt-8">
            測試預設帳號：<code>demo</code>　密碼：<code>demo1234</code><br/>
            實務請改為後端驗證與雜湊儲存。
          </p>
          <div class="mt-8 row" style="align-items:center; justify-content:space-between;">
            <div class="status" id="login-status"></div>
            <div>
              <button id="btn-login">登入系統</button>
              <button id="btn-login-clear" class="secondary">清除</button>
            </div>
          </div>
        </div>

        <!-- 圖形鎖 & 資安提示 -->
        <div class="card">
          <div class="card-header">
            <h3>第二道驗證：圖形鎖</h3>
            <span class="tag">Pattern Lock</span>
          </div>
          <p class="tiny">請依順序點擊 3×3 節點，解鎖圖形鎖。（預設樣板，實務請改為後端驗證）</p>

          <div class="pattern-lock" id="pattern-lock"></div>
          <div class="tiny">目前輸入序列：<span id="pattern-display">（尚未輸入）</span></div>
          <div class="status" id="pattern-status"></div>

          <p class="tiny mt-8">
            帳號登入安全策略（前端示意，實務應由後端強制）：<br/>
            ・同一帳號連續錯誤 <b>3</b> 次 → 暫時鎖定 <b>10 分鐘</b><br/>
            ・累計錯誤 <b>5</b> 次 → 永久鎖定，由管理人員解鎖<br/>
            ・IP 鎖建議於後端記錄來源 IP，配合防火牆或反向代理。
          </p>
        </div>
      </div>
    </div>

    <!-- ========== Main App View ========== -->
    <div id="app-view">
      <!-- 基本資訊：學號 & 到職日 & 按鈕列 -->
      <div class="section mt-16">
        <div class="section-header">
          <h2>時薪人員時數計算</h2>
          <span class="tag" id="logged-user-label">已登入使用者：—</span>
        </div>

        <!-- 學號查詢 -->
        <div class="row mb-12">
          <div class="col" style="max-width:260px;">
            <label for="student-id">學號</label>
            <input type="text" id="student-id" placeholder="請輸入學號，例如：412345678" />
          </div>
          <div class="col" style="flex:0 0 auto; align-self:flex-end;">
            <button id="btn-search-student">
              查詢
            </button>
          </div>
        </div>

        <!-- 到職日 -->
        <div class="row">
          <div class="col" style="max-width:360px;">
            <label>到職日（yyyy / mm / dd）</label>
            <div class="row">
              <div class="col">
                <select id="hire-year"></select>
              </div>
              <div class="col">
                <select id="hire-month"></select>
              </div>
              <div class="col">
                <select id="hire-day"></select>
              </div>
            </div>
          </div>
          <div class="col">
            <p class="tiny">
              ※ 月份中間若有空白（完全沒有該月工時資料列）則不列入年資月份；<br/>
              ※ 計算僅採用欄位中實際輸入的工時（含 0 小時）。
            </p>
          </div>
        </div>

        <!-- 按鈕列 -->
        <div class="row mt-12" style="justify-content:flex-start; gap:8px; flex-wrap:wrap;">
          <button id="btn-add-row">＋ 新增下一筆資料</button>
          <button id="btn-calc" class="secondary">開始計算</button>
          <button id="btn-clear" class="secondary">全部清除</button>
          <button id="btn-export" class="secondary">匯出 Excel</button>
        </div>
      </div>

      <!-- 每月工時登記 -->
      <div class="section mt-16">
        <div class="section-header">
          <h2>每月工時登記</h2>
          <span class="tiny">預設排序：年份 / 月份 由新到舊（Z → A）</span>
        </div>

        <table>
          <thead>
            <tr>
              <th data-sort-key="year">年 ▲▼</th>
              <th data-sort-key="month">月 ▲▼</th>
              <th data-sort-key="hours">當月工時（小時） ▲▼</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="hours-body">
            <!-- 動態插入 -->
          </tbody>
        </table>
        <p class="tiny mt-8">
          ※ (年)、(月) 為下拉選單，當月工時僅接受數值；建議區間 0～999。<br/>
          ※ 第一筆預設帶入到職年月（yyyy / mm）。
        </p>
      </div>

      <!-- 計算結果 -->
      <div class="section mt-16">
        <div class="section-header">
          <h2>計算結果</h2>
        </div>
        <div id="calc-message" class="tiny" style="margin-bottom:8px; color:#9ca3af;">
          尚未計算，請輸入到職日與每月工時後，按下「開始計算」。
        </div>
        <div class="result-grid">
          <div class="pill">
            <div class="pill-label">累計有效月份（有資料列）</div>
            <div id="res-months">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">累計總工時（含 0 小時月份）</div>
            <div id="res-total-hours">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">適用年資區間</div>
            <div id="res-bracket">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">法定年休假天數（對應區間）</div>
            <div id="res-legal-days">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">換算標準工時（小時）</div>
            <div id="res-standard-hours">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">部分工時特休時數（小時）</div>
            <div id="res-leave-hours">—</div>
          </div>
          <div class="pill">
            <div class="pill-label">折算天數（以 8 小時為 1 日）</div>
            <div id="res-leave-days">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /************************************************
     * 登入 & 資安相關（前端示意版）
     ************************************************/

    const LOGIN_ACCOUNT = "demo";
    const LOGIN_PASSWORD = "demo1234";
    const LOGIN_PATTERN = "1-2-3-5-8"; // 預設圖形鎖序列（可自行修改）

    let currentPattern = [];
    let isPatternVerified = false;

    const loginStatusEl = document.getElementById("login-status");
    const patternStatusEl = document.getElementById("pattern-status");
    const patternDisplayEl = document.getElementById("pattern-display");

    function loadLockState() {
      const raw = localStorage.getItem("hourly_leave_lock_state");
      if (!raw) {
        return {
          failCount: 0,
          tempLockUntil: 0,
          permanentlyLocked: false
        };
      }
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {
          failCount: 0,
          tempLockUntil: 0,
          permanentlyLocked: false
        };
      }
    }

    function saveLockState(state) {
      localStorage.setItem("hourly_leave_lock_state", JSON.stringify(state));
    }

    function showLoginStatus(msg, type = "") {
      loginStatusEl.textContent = msg;
      loginStatusEl.className = "status " + (type || "");
    }

    function showPatternStatus(msg, type = "") {
      patternStatusEl.textContent = msg;
      patternStatusEl.className = "status " + (type || "");
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString("zh-TW", { hour12: false });
    }

    // 登入流程
    document.getElementById("btn-login").addEventListener("click", () => {
      const account = document.getElementById("login-account").value.trim();
      const password = document.getElementById("login-password").value;

      const lockState = loadLockState();
      const now = Date.now();

      if (lockState.permanentlyLocked) {
        showLoginStatus("帳號已永久鎖定，請聯繫管理人員解鎖。", "error");
        return;
      }
      if (lockState.tempLockUntil && now < lockState.tempLockUntil) {
        showLoginStatus(
          `帳號暫時鎖定中，請於 ${formatTime(lockState.tempLockUntil)} 之後再嘗試。`,
          "warn"
        );
        return;
      }

      if (!isPatternVerified) {
        showLoginStatus("請先通過圖形鎖驗證。", "warn");
        return;
      }

      if (account === LOGIN_ACCOUNT && password === LOGIN_PASSWORD) {
        // 登入成功：清空鎖定資訊
        saveLockState({ failCount: 0, tempLockUntil: 0, permanentlyLocked: false });
        showLoginStatus("登入成功，正在進入系統…", "ok");
        setTimeout(() => enterApp(account), 400);
      } else {
        // 登入失敗：更新鎖定狀態
        lockState.failCount = (lockState.failCount || 0) + 1;
        let msg = `帳號或密碼錯誤（第 ${lockState.failCount} 次）。`;

        if (lockState.failCount >= 3 && lockState.failCount < 5) {
          const lockMinutes = 10;
          lockState.tempLockUntil = now + lockMinutes * 60 * 1000;
          msg += ` 已暫時鎖定 ${lockMinutes} 分鐘。`;
        } else if (lockState.failCount >= 5) {
          lockState.permanentlyLocked = true;
          msg += " 已達 5 次錯誤，帳號永久鎖定，請聯繫管理人員。";
        }

        saveLockState(lockState);
        showLoginStatus(msg, "error");
      }
    });

    document.getElementById("btn-login-clear").addEventListener("click", () => {
      document.getElementById("login-account").value = "";
      document.getElementById("login-password").value = "";
      showLoginStatus("");
    });

    function enterApp(account) {
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "block";
      document.getElementById("logged-user-label").textContent = "已登入使用者：" + account;
    }

    // 圖形鎖初始化
    (function initPatternLock() {
      const container = document.getElementById("pattern-lock");
      for (let i = 1; i <= 9; i++) {
        const node = document.createElement("div");
        node.className = "pattern-node";
        node.dataset.index = String(i);
        node.textContent = i;
        node.addEventListener("click", onPatternNodeClick);
        container.appendChild(node);
      }
    })();

    function onPatternNodeClick(e) {
      const node = e.currentTarget;
      const idx = node.dataset.index;
      if (!idx) return;

      if (!currentPattern.includes(idx)) {
        currentPattern.push(idx);
        node.classList.add("active");
        patternDisplayEl.textContent = currentPattern.join(" - ");
      }

      // 略示意：最少 4 點後開始判斷
      if (currentPattern.length >= 4) {
        const seq = currentPattern.join("-");
        if (seq === LOGIN_PATTERN) {
          isPatternVerified = true;
          showPatternStatus("圖形鎖驗證成功。", "ok");
        } else {
          isPatternVerified = false;
          showPatternStatus("圖形鎖不正確，請重新輸入。", "error");
        }
      }
    }

    // 重設圖形鎖（雙擊容器）
    document.getElementById("pattern-lock").addEventListener("dblclick", () => {
      currentPattern = [];
      isPatternVerified = false;
      patternDisplayEl.textContent = "（尚未輸入）";
      showPatternStatus("已清除圖形鎖輸入。", "warn");
      document.querySelectorAll(".pattern-node").forEach(n => n.classList.remove("active"));
    });

    /************************************************
     * 主程式：時數登記與特休計算
     ************************************************/

    let hoursData = []; // { id, year, month, hours }
    let sortState = { key: "year", direction: "desc" };

    const hireYearSel = document.getElementById("hire-year");
    const hireMonthSel = document.getElementById("hire-month");
    const hireDaySel = document.getElementById("hire-day");
    const hoursBody = document.getElementById("hours-body");

    function initHireDateOptions() {
      const now = new Date();
      const curYear = now.getFullYear();
      const minYear = curYear - 10;
      const maxYear = curYear + 1;

      // 年
      hireYearSel.innerHTML = "";
      for (let y = maxYear; y >= minYear; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y.toString();
        hireYearSel.appendChild(opt);
      }
      // 月
      hireMonthSel.innerHTML = "";
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = String(m).padStart(2, "0");
        opt.textContent = String(m).padStart(2, "0");
        hireMonthSel.appendChild(opt);
      }
      // 日
      hireDaySel.innerHTML = "";
      for (let d = 1; d <= 31; d++) {
        const opt = document.createElement("option");
        opt.value = String(d).padStart(2, "0");
        opt.textContent = String(d).padStart(2, "0");
        hireDaySel.appendChild(opt);
      }

      // 預設今天
      hireYearSel.value = String(curYear);
      hireMonthSel.value = String(now.getMonth() + 1).padStart(2, "0");
      hireDaySel.value = String(now.getDate()).padStart(2, "0");
    }

    initHireDateOptions();

    function renderHoursTable() {
      // sort
      const data = [...hoursData];
      data.sort((a, b) => {
        if (sortState.key === "year") {
          if (a.year === b.year) return sortState.direction === "asc" ? a.month - b.month : b.month - a.month;
          return sortState.direction === "asc" ? a.year - b.year : b.year - a.year;
        } else if (sortState.key === "month") {
          if (a.year === b.year) {
            return sortState.direction === "asc" ? a.month - b.month : b.month - a.month;
          }
          return sortState.direction === "asc" ? a.year - b.year : b.year - a.year;
        } else if (sortState.key === "hours") {
          return sortState.direction === "asc" ? a.hours - b.hours : b.hours - a.hours;
        }
        return 0;
      });

      hoursBody.innerHTML = "";
      for (const row of data) {
        const tr = document.createElement("tr");

        // 年
        const tdY = document.createElement("td");
        const selY = document.createElement("select");
        for (let y = parseInt(hireYearSel.value, 10) + 10; y >= parseInt(hireYearSel.value, 10) - 1; y--) {
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = String(y);
          selY.appendChild(opt);
        }
        selY.value = String(row.year);
        selY.addEventListener("change", () => {
          row.year = parseInt(selY.value, 10);
        });
        tdY.appendChild(selY);
        tr.appendChild(tdY);

        // 月
        const tdM = document.createElement("td");
        const selM = document.createElement("select");
        for (let m = 1; m <= 12; m++) {
          const opt = document.createElement("option");
          opt.value = String(m).padStart(2, "0");
          opt.textContent = String(m).padStart(2, "0");
          selM.appendChild(opt);
        }
        selM.value = String(row.month).padStart(2, "0");
        selM.addEventListener("change", () => {
          row.month = parseInt(selM.value, 10);
        });
        tdM.appendChild(selM);
        tr.appendChild(tdM);

        // 當月工時
        const tdH = document.createElement("td");
        const inputH = document.createElement("input");
        inputH.type = "number";
        inputH.step = "0.1";
        inputH.min = "0";   // 允許 0 小時
        inputH.max = "999";
        inputH.value = row.hours.toString();
        inputH.addEventListener("change", () => {
          const v = parseFloat(inputH.value);
          if (isNaN(v) || v < 0 || v > 999) {
            alert("當月工時請輸入 0～999 間的數值。");
            inputH.value = row.hours.toString();
          } else {
            row.hours = v;
          }
        });
        tdH.appendChild(inputH);
        tr.appendChild(tdH);

        // 刪除
        const tdDel = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.textContent = "刪除";
        btnDel.className = "btn-icon danger";
        btnDel.addEventListener("click", () => {
          hoursData = hoursData.filter(r => r.id !== row.id);
          renderHoursTable();
        });
        tdDel.appendChild(btnDel);
        tr.appendChild(tdDel);

        hoursBody.appendChild(tr);
      }
    }

    function addNewRowFromButton() {
      let year = parseInt(hireYearSel.value, 10);
      let month = parseInt(hireMonthSel.value, 10);

      if (hoursData.length > 0) {
        // 以目前最「新」的資料當作基準，+1 月
        const newest = [...hoursData].sort((a, b) => (b.year - a.year) || (b.month - a.month))[0];
        year = newest.year;
        month = newest.month + 1;
        if (month > 12) {
          month = 1;
          year += 1;
        }
      }

      const id = crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      hoursData.push({
        id,
        year,
        month,
        hours: 0
      });

      // 預設排序：由新到舊
      sortState.key = "year";
      sortState.direction = "desc";
      renderHoursTable();
    }

    document.getElementById("btn-add-row").addEventListener("click", () => {
      // 若完全沒有任何資料列，第一筆會帶入到職年月
      if (hoursData.length === 0) {
        const id = crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now();
        hoursData.push({
          id,
          year: parseInt(hireYearSel.value, 10),
          month: parseInt(hireMonthSel.value, 10),
          hours: 0
        });
        sortState.key = "year";
        sortState.direction = "desc";
        renderHoursTable();
      } else {
        addNewRowFromButton();
      }
    });

    // 表頭排序
    document.querySelectorAll("thead th[data-sort-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.sortKey;
        if (sortState.key === key) {
          sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
        } else {
          sortState.key = key;
          sortState.direction = "desc"; // 點擊新欄位時預設由新到舊
        }
        renderHoursTable();
      });
    });

    // 全部清除
    document.getElementById("btn-clear").addEventListener("click", () => {
      if (!confirm("確定要清除此頁面上的到職日與每月工時資料？")) return;
      hoursData = [];
      renderHoursTable();
      document.getElementById("student-id").value = "";
      initHireDateOptions();
      resetResultDisplay();
    });

    // 學號查詢（目前前端樣板：只有 demo）
    document.getElementById("btn-search-student").addEventListener("click", () => {
      const sid = document.getElementById("student-id").value.trim();
      if (!sid) {
        alert("請先輸入學號。");
        return;
      }

      const data = fetchStudentDataMock(sid);
      if (!data) {
        const msg = `"${sid}" 未登入過資料或是輸入錯誤，新登記學號請按「確定」，重新查詢請按「取消」離開頁面。`;
        const ok = confirm(msg);
        if (ok) {
          // 新登記：清空目前資料
          hoursData = [];
          renderHoursTable();
          resetResultDisplay();
        } else {
          // 取消：僅清空學號欄位
          document.getElementById("student-id").value = "";
        }
        return;
      }

      // 有資料：載入到職日與時數
      hireYearSel.value = String(data.hireYear);
      hireMonthSel.value = String(data.hireMonth).padStart(2, "0");
      hireDaySel.value = String(data.hireDay).padStart(2, "0");

      hoursData = data.records.map(r => ({
        id: crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now() + "-" + Math.random().toString(16).slice(2),
        year: r.year,
        month: r.month,
        hours: r.hours
      }));
      sortState.key = "year";
      sortState.direction = "desc";
      renderHoursTable();
      resetResultDisplay();
    });

    // Mock：僅供測試，可替換為實際後端 API
    function fetchStudentDataMock(sid) {
      if (sid === "demo") {
        return {
          hireYear: 2023,
          hireMonth: 3,
          hireDay: 1,
          records: [
            { year: 2023, month: 3, hours: 33 },
            { year: 2023, month: 4, hours: 0 },   // 特別示範 0 小時也算月份
            { year: 2023, month: 5, hours: 45 },
            { year: 2023, month: 7, hours: 60 },  // 故意跳過 6 月，表示該月不列入年資
          ]
        };
      }
      // 其他學號目前都視為無紀錄
      return null;
    }

    // 計算特休
    document.getElementById("btn-calc").addEventListener("click", () => {
      if (hoursData.length === 0) {
        alert("請先建立至少一筆每月工時資料。");
        return;
      }

      // 只計算有資料的月份（含 0 小時）
      const validRows = hoursData.filter(r => typeof r.hours === "number" && !isNaN(r.hours));
      const monthsCount = validRows.length;
      const totalHours = validRows.reduce((sum, r) => sum + r.hours, 0);

      const bracket = determineBracketByMonths(monthsCount);
      if (!bracket) {
        document.getElementById("calc-message").textContent =
          "有效月份未滿 6 個月，目前依勞基法不產生特別休假（此結果只作為概算參考）。";
        document.getElementById("res-months").textContent = monthsCount.toString();
        document.getElementById("res-total-hours").textContent = totalHours.toFixed(1);
        document.getElementById("res-bracket").textContent = "未滿 6 個月（不適用特休）";
        document.getElementById("res-legal-days").textContent = "—";
        document.getElementById("res-standard-hours").textContent = "—";
        document.getElementById("res-leave-hours").textContent = "—";
        document.getElementById("res-leave-days").textContent = "—";
        return;
      }

      const { label, legalDays, standardHours } = bracket;
      const leaveHours = totalHours / standardHours * 8 * legalDays;
      const leaveDays = leaveHours / 8;

      document.getElementById("calc-message").textContent =
        "已依目前欄位內的工時資料（含 0 小時月份、不含完全缺漏的月份）進行部分工時特休試算。";
      document.getElementById("res-months").textContent = monthsCount.toString();
      document.getElementById("res-total-hours").textContent = totalHours.toFixed(1);
      document.getElementById("res-bracket").textContent = label;
      document.getElementById("res-legal-days").textContent = legalDays + " 日";
      document.getElementById("res-standard-hours").textContent = standardHours + " 小時";
      document.getElementById("res-leave-hours").textContent = leaveHours.toFixed(2) + " 小時";
      document.getElementById("res-leave-days").textContent = leaveDays.toFixed(2) + " 日";
    });

    function resetResultDisplay() {
      document.getElementById("calc-message").textContent =
        "尚未計算，請輸入到職日與每月工時後，按下「開始計算」。";
      document.getElementById("res-months").textContent = "—";
      document.getElementById("res-total-hours").textContent = "—";
      document.getElementById("res-bracket").textContent = "—";
      document.getElementById("res-legal-days").textContent = "—";
      document.getElementById("res-standard-hours").textContent = "—";
      document.getElementById("res-leave-hours").textContent = "—";
      document.getElementById("res-leave-days").textContent = "—";
    }

    // 依「有效月份數」決定適用公式區間
    // 這裡依你給的 4 個公式簡化成「以有資料的月份數」當作年資的概算：
    //   6 個月：3 日（1044 小時）
    //   第 2 年：7 日（2088 小時）
    //   第 3 年：10 日（2088 小時）
    //   第 4～5 年：14 日（2088 小時）
    function determineBracketByMonths(monthsCount) {
      if (monthsCount < 6) {
        return null;
      }
      // 6 ～ 11 個「有資料月份」：視為第 1 年（滿 6 個月）
      if (monthsCount >= 6 && monthsCount < 12) {
        return {
          label: "到職滿 6 個月以上未滿 1 年",
          legalDays: 3,
          standardHours: 1044
        };
      }
      // 12 ～ 23 個：第 2 年
      if (monthsCount >= 12 && monthsCount < 24) {
        return {
          label: "到職第 2 年",
          legalDays: 7,
          standardHours: 2088
        };
      }
      // 24 ～ 35 個：第 3 年
      if (monthsCount >= 24 && monthsCount < 36) {
        return {
          label: "到職第 3 年",
          legalDays: 10,
          standardHours: 2088
        };
      }
      // 36 ～ 59 個：第 4～5 年（簡化）
      return {
        label: "到職第 4～5 年（簡化區間）",
        legalDays: 14,
        standardHours: 2088
      };
    }

    // 匯出 Excel
    document.getElementById("btn-export").addEventListener("click", () => {
      if (hoursData.length === 0) {
        alert("尚未有任何每月工時資料，無法匯出。");
        return;
      }

      // 先確保目前畫面的計算結果是最新的（不強迫，但提醒）
      if (!confirm("建議先按「開始計算」更新試算結果，再匯出。是否繼續匯出？")) {
        return;
      }

      // 組成資料表：每月工時
      const header = ["年", "月", "當月工時（小時）"];
      const rows = [...hoursData]
        .sort((a, b) => (b.year - a.year) || (b.month - a.month)) // 由新到舊
        .map(r => [r.year, r.month, r.hours]);

      const wsData = [header, ...rows];

      // 在下方加上計算結果摘要
      wsData.push([]);
      wsData.push(["試算摘要"]);
      wsData.push(["有效月份數", document.getElementById("res-months").textContent]);
      wsData.push(["累計總工時", document.getElementById("res-total-hours").textContent]);
      wsData.push(["適用年資區間", document.getElementById("res-bracket").textContent]);
      wsData.push(["法定年休假天數", document.getElementById("res-legal-days").textContent]);
      wsData.push(["換算標準工時", document.getElementById("res-standard-hours").textContent]);
      wsData.push(["部分工時特休時數", document.getElementById("res-leave-hours").textContent]);
      wsData.push(["折算特休天數（8 小時/日）", document.getElementById("res-leave-days").textContent]);

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "時薪特休試算");

      const sid = document.getElementById("student-id").value.trim() || "noid";
      const fileName = `hourly_leave_${sid}_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

  </script>
</body>
</html>
