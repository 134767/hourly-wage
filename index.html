<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>時薪人員特休計算系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 匯出 Excel 用的 SheetJS（前端生成 .xlsx） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #C4E1FF; /* 淺藍色，長輩友善 */
      color: #111827;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .app-shell {
      max-width: 1100px;
      width: 100%;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      border: 1px solid #93c5fd;
    }
    h1, h2, h3 {
      margin: 0 0 12px;
      font-weight: 600;
      color: #0f172a;
    }
    h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span.badge {
      font-size: 11px;
      background: #2563eb;
      padding: 2px 8px;
      border-radius: 999px;
      color: #eff6ff;
    }
    p {
      margin: 4px 0 8px;
      font-size: 13px;
      color: #374151;
    }

    label {
      font-size: 14px;
      color: #111827;
      display: block;
      margin-bottom: 4px;
    }
    input, select, button {
      font-family: inherit;
      font-size: 14px;
    }
    input[type="text"], input[type="password"], input[type="number"], select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #9ca3af;
      background: #ffffff;
      color: #111827;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }
    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button.secondary {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #9ca3af;
    }
    button.danger {
      background: #dc2626;
      color: #fef2f2;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .col {
      flex: 1;
      min-width: 160px;
    }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }

    .section {
      border-radius: 12px;
      border: 1px solid #bfdbfe;
      padding: 12px 16px 16px;
      background: #eff6ff;
      margin-top: 12px;
    }
    .section-header-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #0f172a;
    }

    /* Login view */
    #login-view {
      display: block;
    }
    #app-view {
      display: none;
    }
    .login-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 16px;
    }
    @media (max-width: 800px) {
      .login-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      border-radius: 12px;
      border: 1px solid #bfdbfe;
      padding: 12px 14px 14px;
      background: #ffffff;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header h3 {
      font-size: 15px;
      color: #111827;
    }
    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .tiny {
      font-size: 12px;
      color: #4b5563;
      text-align: left;
    }
    .status {
      font-size: 12px;
      margin-top: 4px;
    }
    .status.ok { color: #16a34a; }
    .status.warn { color: #ca8a04; }
    .status.error { color: #dc2626; }

    /* 圖形文字鎖 (Captcha) */
    .captcha-box {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .captcha-display {
      height: 52px;
      border-radius: 10px;
      border: 1px solid #9ca3af;
      background: repeating-linear-gradient(
        135deg,
        #dbeafe,
        #dbeafe 8px,
        #eff6ff 8px,
        #eff6ff 16px
      );
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 4px;
      font-weight: 700;
      font-size: 22px;
      color: #1f2937;
      text-shadow: 0 0 3px rgba(255,255,255,0.6);
      user-select: none;
    }
    .captcha-display span {
      transform: skewX(-6deg) rotate(-1deg);
      display: inline-block;
    }
    .captcha-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .captcha-row input {
      flex: 1;
    }
    .captcha-row button {
      flex-shrink: 0;
      padding-inline: 10px;
      font-size: 12px;
    }

    /* Hours table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background: #dbeafe;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
      color: #111827;
    }
    th {
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr:nth-child(odd) {
      background: #ffffff;
    }
    .btn-icon {
      padding: 3px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* Summary box (右側) */
    .summary-box {
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #bfdbfe;
      padding: 10px 12px;
      font-size: 12px;
      color: #111827;
    }
    .summary-box-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .summary-row {
      margin-bottom: 2px;
      line-height: 1.6;
    }
    .summary-row strong {
      font-weight: 600;
    }
    .summary-legal {
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <h1>
      時薪人員特休計算系統
      <span class="badge">GitHub Pages 版本</span>
    </h1>
    <p>※ 此版本為前端樣板，帳號鎖定 / 圖形文字鎖 / IP 鎖等資安機制請搭配後端實作。</p>

    <!-- ========== Login View ========== -->
    <div id="login-view">
      <div class="login-grid mt-12">
        <!-- 帳號 / 密碼 -->
        <div class="card">
          <div class="card-header">
            <h3>登入驗證</h3>
            <span class="tag">帳號＋密碼</span>
          </div>
          <div class="row">
            <div class="col">
              <label for="login-account">帳號</label>
              <input type="text" id="login-account" placeholder="例如：staff01" autocomplete="username" />
            </div>
            <div class="col">
              <label for="login-password">密碼</label>
              <input type="password" id="login-password" placeholder="請輸入密碼" autocomplete="current-password" />
            </div>
          </div>
          <p class="tiny mt-8">
            測試預設帳號：<code>demo</code>　密碼：<code>demo1234</code><br/>
            實務請改為後端驗證與雜湊儲存。
          </p>
          <div class="mt-8 row" style="align-items:center; justify-content:space-between;">
            <div class="status" id="login-status"></div>
            <div>
              <button id="btn-login">登入系統</button>
              <button id="btn-login-clear" class="secondary">清除</button>
            </div>
          </div>
        </div>

        <!-- 圖形文字鎖 & 資安提示 -->
        <div class="card">
          <div class="card-header">
            <h3>第二道驗證：圖形文字鎖</h3>
            <span class="tag">驗證碼</span>
          </div>
          <p class="tiny">
            依畫面中的圖形文字輸入（數字、英文，大小寫皆可），通過後才允許登入。
          </p>

          <div class="captcha-box">
            <div class="captcha-display">
              <span id="captcha-text">------</span>
            </div>
            <div class="captcha-row">
              <input
                type="text"
                id="captcha-input"
                placeholder="請依上方圖形輸入文字（不分大小寫）"
                autocomplete="off"
              />
              <button id="btn-refresh-captcha" class="secondary">重新產生</button>
            </div>
          </div>

          <div class="status" id="captcha-status"></div>

          <p class="tiny mt-8">
            帳號登入安全策略（前端示意，實務應由後端強制）：<br/>
            ・同一帳號連續錯誤 <b>3</b> 次 → 暫時鎖定 <b>10 分鐘</b><br/>
            ・累計錯誤 <b>5</b> 次 → 永久鎖定，由管理人員解鎖<br/>
            ・IP 鎖建議於後端記錄來源 IP，配合防火牆或反向代理。
          </p>
        </div>
      </div>
    </div>

    <!-- ========== Main App View ========== -->
    <div id="app-view">
      <!-- 上方：左側基本資料 / 右側計算結果 -->
      <div class="section mt-16">
        <div class="row">
          <!-- 左側：時數計算 & 學號 -->
          <div class="col" style="min-width:320px; flex:1.4;">
            <div class="section-header-title">時薪人員時數計算</div>
            <div class="tiny mb-8" id="logged-user-label">已登入使用者：—</div>

            <!-- 學號查詢 -->
            <div class="row mb-12">
              <div class="col" style="max-width:260px;">
                <label for="student-id">學號</label>
                <input type="text" id="student-id" placeholder="請輸入學號，例如：412345678" />
              </div>
              <div class="col" style="flex:0 0 auto; align-self:flex-end;">
                <button id="btn-search-student">查詢</button>
              </div>
            </div>

            <!-- 到職日 -->
            <div class="row">
              <div class="col" style="max-width:360px;">
                <label>到職日（yyyy / mm / dd）</label>
                <div class="row">
                  <div class="col">
                    <select id="hire-year"></select>
                  </div>
                  <div class="col">
                    <select id="hire-month"></select>
                  </div>
                  <div class="col">
                    <select id="hire-day"></select>
                  </div>
                </div>
              </div>
            </div>
            <p class="tiny mt-8">
              ※ 月份中間若有空白（完全沒有該月工時資料列）則不列入年資月份；<br/>
              ※ 計算僅採用欄位中實際輸入的工時（含 0 小時）。
            </p>

            <!-- 按鈕列 -->
            <div class="row mt-12" style="justify-content:flex-start; gap:8px; flex-wrap:wrap;">
              <button id="btn-add-row">＋ 新增下一筆資料</button>
              <button id="btn-calc" class="secondary">開始計算</button>
              <button id="btn-clear" class="secondary">全部清除</button>
              <button id="btn-export" class="secondary">匯出 Excel</button>
            </div>
          </div>

          <!-- 右側：計算結果摘要 -->
          <div class="col" style="min-width:260px; flex:1;">
            <div class="summary-box">
              <div class="summary-box-title">試算結果摘要</div>
              <div id="calc-message" class="tiny" style="margin-bottom:8px;">
                尚未計算，請輸入到職日與每月工時後，按下「開始計算」。
              </div>

              <div class="summary-row">
                <strong>任職區間：</strong><span id="res-period">—</span>
              </div>
              <div class="summary-row">
                <strong>共</strong> <span id="res-period-months">—</span> <strong>月</strong>
              </div>
              <div class="summary-row">
                <strong>總工時：</strong><span id="res-total-hours">—</span> 小時
              </div>
              <div class="summary-row">
                <strong>累計年資：</strong><span id="res-seniority">—</span>
              </div>

              <div class="summary-legal">
                <strong>法定特休計算</strong>
                <div id="res-legal-list" class="tiny" style="margin-top:4px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 每月工時登記 -->
      <div class="section mt-16">
        <div class="section-header-title">每月工時登記</div>
        <p class="tiny">預設排序：年份 / 月份 由新到舊（Z → A）</p>

        <table>
          <thead>
            <tr>
              <th data-sort-key="year">年 ▲▼</th>
              <th data-sort-key="month">月 ▲▼</th>
              <th data-sort-key="hours">當月工時（小時） ▲▼</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="hours-body">
            <!-- 動態插入 -->
          </tbody>
        </table>
        <p class="tiny mt-8">
          ※ (年)、(月) 為下拉選單，當月工時僅接受數值；建議區間 0～999。<br/>
          ※ 第一筆預設帶入到職年月（yyyy / mm）。
        </p>
      </div>
    </div>
  </div>

  <script>
    /************************************************
     * 共用小工具（日期處理）
     ************************************************/
    function pad2(n) {
      return String(n).padStart(2, "0");
    }
    function makeDateFromYMD(y, m, d) {
      return new Date(y, m - 1, d);
    }
    function formatDate(d) {
      const y = d.getFullYear();
      const m = pad2(d.getMonth() + 1);
      const day = pad2(d.getDate());
      return `${y}-${m}-${day}`;
    }
    function addMonths(date, months) {
      const d = new Date(date.getTime());
      const newMonth = d.getMonth() + months;
      d.setMonth(newMonth);
      return d;
    }

    /************************************************
     * 登入 & 資安相關（前端示意版）
     ************************************************/

    const LOGIN_ACCOUNT = "demo";
    const LOGIN_PASSWORD = "demo1234";

    let currentCaptcha = "";

    const loginStatusEl = document.getElementById("login-status");
    const captchaStatusEl = document.getElementById("captcha-status");
    const captchaTextEl = document.getElementById("captcha-text");
    const captchaInputEl = document.getElementById("captcha-input");

    function loadLockState() {
      const raw = localStorage.getItem("hourly_leave_lock_state");
      if (!raw) {
        return {
          failCount: 0,
          tempLockUntil: 0,
          permanentlyLocked: false
        };
      }
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {
          failCount: 0,
          tempLockUntil: 0,
          permanentlyLocked: false
        };
      }
    }

    function saveLockState(state) {
      localStorage.setItem("hourly_leave_lock_state", JSON.stringify(state));
    }

    function showLoginStatus(msg, type = "") {
      loginStatusEl.textContent = msg;
      loginStatusEl.className = "status " + (type || "");
    }

    function showCaptchaStatus(msg, type = "") {
      captchaStatusEl.textContent = msg;
      captchaStatusEl.className = "status " + (type || "");
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString("zh-TW", { hour12: false });
    }

    function generateCaptcha(length = 5) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      currentCaptcha = result;
      captchaTextEl.textContent = result;
      captchaInputEl.value = "";
      showCaptchaStatus("請依圖形文字輸入，不分大小寫。", "tiny");
    }

    function validateCaptcha(input) {
      if (!currentCaptcha) return false;
      return input.trim().toLowerCase() === currentCaptcha.trim().toLowerCase();
    }

    // 初始化圖形文字鎖
    generateCaptcha();
    document.getElementById("btn-refresh-captcha").addEventListener("click", () => {
      generateCaptcha();
      showCaptchaStatus("已重新產生圖形文字鎖。", "warn");
    });

    // 登入流程
    document.getElementById("btn-login").addEventListener("click", () => {
      const account = document.getElementById("login-account").value.trim();
      const password = document.getElementById("login-password").value;
      const captchaInput = captchaInputEl.value.trim();

      const lockState = loadLockState();
      const now = Date.now();

      if (lockState.permanentlyLocked) {
        showLoginStatus("帳號已永久鎖定，請聯繫管理人員解鎖。", "error");
        return;
      }
      if (lockState.tempLockUntil && now < lockState.tempLockUntil) {
        showLoginStatus(
          `帳號暫時鎖定中，請於 ${formatTime(lockState.tempLockUntil)} 之後再嘗試。`,
          "warn"
        );
        return;
      }

      // 先檢查圖形文字鎖
      if (!captchaInput) {
        showCaptchaStatus("請先輸入圖形文字鎖。", "warn");
        return;
      }
      if (!validateCaptcha(captchaInput)) {
        showCaptchaStatus("圖形文字鎖不正確，已重新產生新組合。", "error");
        generateCaptcha();
        return;
      }
      showCaptchaStatus("圖形文字鎖驗證通過。", "ok");

      // 再檢查帳號密碼
      if (account === LOGIN_ACCOUNT && password === LOGIN_PASSWORD) {
        // 登入成功：清空鎖定資訊
        saveLockState({ failCount: 0, tempLockUntil: 0, permanentlyLocked: false });
        showLoginStatus("登入成功，正在進入系統…", "ok");
        setTimeout(() => enterApp(account), 400);
      } else {
        // 登入失敗：更新鎖定狀態
        lockState.failCount = (lockState.failCount || 0) + 1;
        let msg = `帳號或密碼錯誤（第 ${lockState.failCount} 次）。`;

        if (lockState.failCount >= 3 && lockState.failCount < 5) {
          const lockMinutes = 10;
          lockState.tempLockUntil = now + lockMinutes * 60 * 1000;
          msg += ` 已暫時鎖定 ${lockMinutes} 分鐘。`;
        } else if (lockState.failCount >= 5) {
          lockState.permanentlyLocked = true;
          msg += " 已達 5 次錯誤，帳號永久鎖定，請聯繫管理人員。";
        }

        saveLockState(lockState);
        showLoginStatus(msg, "error");
        generateCaptcha(); // 防暴力：錯誤後重生 captcha
      }
    });

    document.getElementById("btn-login-clear").addEventListener("click", () => {
      document.getElementById("login-account").value = "";
      document.getElementById("login-password").value = "";
      captchaInputEl.value = "";
      showLoginStatus("");
      showCaptchaStatus("");
      generateCaptcha();
    });

    function enterApp(account) {
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "block";
      document.getElementById("logged-user-label").textContent = "已登入使用者：" + account;
    }

    /************************************************
     * 主程式：時數登記與特休計算
     ************************************************/

    let hoursData = []; // { id, year, month, hours }
    let sortState = { key: "year", direction: "desc" };

    const hireYearSel = document.getElementById("hire-year");
    const hireMonthSel = document.getElementById("hire-month");
    const hireDaySel = document.getElementById("hire-day");
    const hoursBody = document.getElementById("hours-body");

    function initHireDateOptions() {
      const now = new Date();
      const curYear = now.getFullYear();
      const minYear = curYear - 10;
      const maxYear = curYear + 1;

      // 年
      hireYearSel.innerHTML = "";
      for (let y = maxYear; y >= minYear; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y.toString();
        hireYearSel.appendChild(opt);
      }
      // 月
      hireMonthSel.innerHTML = "";
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = String(m).padStart(2, "0");
        opt.textContent = String(m).padStart(2, "0");
        hireMonthSel.appendChild(opt);
      }
      // 日
      hireDaySel.innerHTML = "";
      for (let d = 1; d <= 31; d++) {
        const opt = document.createElement("option");
        opt.value = String(d).padStart(2, "0");
        opt.textContent = String(d).padStart(2, "0");
        hireDaySel.appendChild(opt);
      }

      // 預設今天
      hireYearSel.value = String(curYear);
      hireMonthSel.value = String(now.getMonth() + 1).padStart(2, "0");
      hireDaySel.value = String(now.getDate()).padStart(2, "0");
    }

    initHireDateOptions();

    // ★ 渲染每月工時：包含 Tab / Enter 像 Excel 一樣往下跳 ★
    function renderHoursTable() {
      const data = [...hoursData];
      data.sort((a, b) => {
        if (sortState.key === "year") {
          if (a.year === b.year) return sortState.direction === "asc" ? a.month - b.month : b.month - a.month;
          return sortState.direction === "asc" ? a.year - b.year : b.year - a.year;
        } else if (sortState.key === "month") {
          if (a.year === b.year) {
            return sortState.direction === "asc" ? a.month - b.month : b.month - a.month;
          }
          return sortState.direction === "asc" ? a.year - b.year : b.year - a.year;
        } else if (sortState.key === "hours") {
          return sortState.direction === "asc" ? a.hours - b.hours : b.hours - a.hours;
        }
        return 0;
      });

      hoursBody.innerHTML = "";
      for (const row of data) {
        const tr = document.createElement("tr");

        // 年
        const tdY = document.createElement("td");
        const selY = document.createElement("select");
        for (let y = parseInt(hireYearSel.value, 10) + 10; y >= parseInt(hireYearSel.value, 10) - 1; y--) {
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = String(y);
          selY.appendChild(opt);
        }
        selY.value = String(row.year);
        selY.addEventListener("change", () => {
          row.year = parseInt(selY.value, 10);
        });
        tdY.appendChild(selY);
        tr.appendChild(tdY);

        // 月
        const tdM = document.createElement("td");
        const selM = document.createElement("select");
        for (let m = 1; m <= 12; m++) {
          const opt = document.createElement("option");
          opt.value = String(m).padStart(2, "0");
          opt.textContent = String(m).padStart(2, "0");
          selM.appendChild(opt);
        }
        selM.value = String(row.month).padStart(2, "0");
        selM.addEventListener("change", () => {
          row.month = parseInt(selM.value, 10);
        });
        tdM.appendChild(selM);
        tr.appendChild(tdM);

        // 當月工時
        const tdH = document.createElement("td");
        const inputH = document.createElement("input");
        inputH.type = "number";
        inputH.step = "0.1";
        inputH.min = "0";   // 允許 0 小時
        inputH.max = "999";
        inputH.value = row.hours.toString();

        // 值變更時更新資料
        inputH.addEventListener("change", () => {
          const v = parseFloat(inputH.value);
          if (isNaN(v) || v < 0 || v > 999) {
            alert("當月工時請輸入 0～999 間的數值。");
            inputH.value = row.hours.toString();
          } else {
            row.hours = v;
          }
        });

        // Tab / Enter 像 Excel 一樣往下跳；Shift+Tab 往上
        inputH.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === "Tab") {
            e.preventDefault();
            const inputs = Array.from(
              document.querySelectorAll('#hours-body input[type="number"]')
            );
            const idx = inputs.indexOf(e.target);
            if (idx === -1) return;
            const nextIndex = e.shiftKey ? idx - 1 : idx + 1;
            if (nextIndex >= 0 && nextIndex < inputs.length) {
              inputs[nextIndex].focus();
              inputs[nextIndex].select();
            }
          }
        });

        tdH.appendChild(inputH);
        tr.appendChild(tdH);

        // 刪除
        const tdDel = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.textContent = "刪除";
        btnDel.className = "btn-icon danger";
        btnDel.addEventListener("click", () => {
          hoursData = hoursData.filter(r => r.id !== row.id);
          renderHoursTable();
        });
        tdDel.appendChild(btnDel);
        tr.appendChild(tdDel);

        hoursBody.appendChild(tr);
      }
    }

    function addNewRowFromButton() {
      let year = parseInt(hireYearSel.value, 10);
      let month = parseInt(hireMonthSel.value, 10);

      if (hoursData.length > 0) {
        // 以目前最「新」的資料當作基準，+1 月
        const newest = [...hoursData].sort((a, b) => (b.year - a.year) || (b.month - a.month))[0];
        year = newest.year;
        month = newest.month + 1;
        if (month > 12) {
          month = 1;
          year += 1;
        }
      }

      const id = crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      hoursData.push({
        id,
        year,
        month,
        hours: 0
      });

      sortState.key = "year";
      sortState.direction = "desc";
      renderHoursTable();
    }

    document.getElementById("btn-add-row").addEventListener("click", () => {
      if (hoursData.length === 0) {
        const id = crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now();
        hoursData.push({
          id,
          year: parseInt(hireYearSel.value, 10),
          month: parseInt(hireMonthSel.value, 10),
          hours: 0
        });
        sortState.key = "year";
        sortState.direction = "desc";
        renderHoursTable();
      } else {
        addNewRowFromButton();
      }
    });

    // 表頭排序
    document.querySelectorAll("thead th[data-sort-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.sortKey;
        if (sortState.key === key) {
          sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
        } else {
          sortState.key = key;
          sortState.direction = "desc";
        }
        renderHoursTable();
      });
    });

    // 全部清除
    document.getElementById("btn-clear").addEventListener("click", () => {
      if (!confirm("確定要清除此頁面上的到職日與每月工時資料？")) return;
      hoursData = [];
      renderHoursTable();
      document.getElementById("student-id").value = "";
      initHireDateOptions();
      resetResultDisplay();
    });

    // 學號查詢（目前前端樣板：只有 demo）
    document.getElementById("btn-search-student").addEventListener("click", () => {
      const sid = document.getElementById("student-id").value.trim();
      if (!sid) {
        alert("請先輸入學號。");
        return;
      }

      const data = fetchStudentDataMock(sid);
      if (!data) {
        const msg = `"${sid}" 未登入過資料或是輸入錯誤，新登記學號請按「確定」，重新查詢請按「取消」離開頁面。`;
        const ok = confirm(msg);
        if (ok) {
          hoursData = [];
          renderHoursTable();
          resetResultDisplay();
        } else {
          document.getElementById("student-id").value = "";
        }
        return;
      }

      // 有資料：載入到職日與時數
      hireYearSel.value = String(data.hireYear);
      hireMonthSel.value = String(data.hireMonth).padStart(2, "0");
      hireDaySel.value = String(data.hireDay).padStart(2, "0");

      hoursData = data.records.map(r => ({
        id: crypto.randomUUID ? crypto.randomUUID() : "id-" + Date.now() + "-" + Math.random().toString(16).slice(2),
        year: r.year,
        month: r.month,
        hours: r.hours
      }));
      sortState.key = "year";
      sortState.direction = "desc";
      renderHoursTable();
      resetResultDisplay();
    });

    // Mock：僅供測試，可替換為實際後端 API
    function fetchStudentDataMock(sid) {
      if (sid === "demo") {
        return {
          hireYear: 2023,
          hireMonth: 3,
          hireDay: 1,
          records: [
            { year: 2023, month: 3, hours: 33 },
            { year: 2023, month: 4, hours: 0 },
            { year: 2023, month: 5, hours: 45 },
            { year: 2023, month: 7, hours: 60 },
          ]
        };
      }
      return null;
    }

    // 法定特休級距設定（用「有效月份數」判斷達到哪一級）
    const LEGAL_THRESHOLDS = [
      { key: "6m",  label: "到職滿 6 個月", monthsRequired: 6,  legalDays: 3,  standardHours: 1044 },
      { key: "1y",  label: "到職滿 1 年",   monthsRequired: 12, legalDays: 7,  standardHours: 2088 },
      { key: "2y",  label: "到職滿 2 年",   monthsRequired: 24, legalDays: 10, standardHours: 2088 },
      { key: "3y",  label: "到職滿 3 年",   monthsRequired: 36, legalDays: 10, standardHours: 2088 },
      { key: "4y",  label: "到職滿 4 年",   monthsRequired: 48, legalDays: 14, standardHours: 2088 },
      { key: "5y",  label: "到職滿 5 年",   monthsRequired: 60, legalDays: 14, standardHours: 2088 },
    ];

    // 回傳目前「已達到」的級距（最高一個）
    function determineBracketByMonths(monthsCount) {
      let hit = null;
      for (const th of LEGAL_THRESHOLDS) {
        if (monthsCount >= th.monthsRequired) {
          hit = th;
        }
      }
      return hit;
    }

    // 回傳「已達到級距」的所有列文字（給畫面與匯出用）
    function getLegalSummaryLines(monthsCount, totalHours, hireDate) {
      const lines = [];
      for (const th of LEGAL_THRESHOLDS) {
        if (monthsCount >= th.monthsRequired) {
          const endDate = addMonths(hireDate, th.monthsRequired);
          const leaveHours = totalHours / th.standardHours * 8 * th.legalDays;
          const range = `(${formatDate(hireDate)} ~ ${formatDate(endDate)})`;
          lines.push(`${range}${th.label}：${leaveHours.toFixed(2)} 小時`);
        }
      }
      return lines;
    }

    // 計算特休
    document.getElementById("btn-calc").addEventListener("click", () => {
      if (hoursData.length === 0) {
        alert("請先建立至少一筆每月工時資料。");
        return;
      }

      const validRows = hoursData.filter(r => typeof r.hours === "number" && !isNaN(r.hours));
      const monthsCount = validRows.length;
      const totalHours = validRows.reduce((sum, r) => sum + r.hours, 0);

      const resPeriodEl = document.getElementById("res-period");
      const resPeriodMonthsEl = document.getElementById("res-period-months");
      const resTotalHoursEl = document.getElementById("res-total-hours");
      const resSeniorityEl = document.getElementById("res-seniority");
      const resLegalListEl = document.getElementById("res-legal-list");
      const calcMsgEl = document.getElementById("calc-message");

      // 任職區間：以「有資料的最早一筆 ~ 最新一筆」表示
      if (validRows.length > 0) {
        const sorted = [...validRows].sort((a, b) =>
          (a.year - b.year) || (a.month - b.month)
        );
        const first = sorted[0];
        const last = sorted[sorted.length - 1];
        const startDate = makeDateFromYMD(first.year, first.month, 1);
        const endDate = makeDateFromYMD(last.year, last.month, 1);
        resPeriodEl.textContent = `${formatDate(startDate)} ~ ${formatDate(endDate)}`;
      } else {
        resPeriodEl.textContent = "—";
      }

      resPeriodMonthsEl.textContent = monthsCount.toString();
      resTotalHoursEl.textContent = totalHours.toFixed(1);

      // 累計年資 (年 / 月，以「有效月份數」概算)
      const years = Math.floor(monthsCount / 12);
      const months = monthsCount % 12;
      if (monthsCount === 0) {
        resSeniorityEl.textContent = "—";
      } else {
        resSeniorityEl.textContent = `${years} 年 ${months} 月（依實際填寫之有效月份概算）`;
      }

      resLegalListEl.innerHTML = "";

      // 若未滿 6 個「有效月份」，不產生特休
      if (monthsCount < 6) {
        calcMsgEl.textContent =
          "有效月份未滿 6 個月，目前依勞基法不產生特別休假（此結果只作為概算參考）。";
        return;
      }

      // 取得到職日
      const hireY = parseInt(hireYearSel.value, 10);
      const hireM = parseInt(hireMonthSel.value, 10);
      const hireD = parseInt(hireDaySel.value, 10);
      const hireDate = makeDateFromYMD(hireY, hireM, hireD);

      // 已達級距清單（顯示 6 個月 / 1 年 / 2 年 / 3 年 / 4 年 / 5 年 中「已達到」的）
      const lines = getLegalSummaryLines(monthsCount, totalHours, hireDate);
      if (lines.length === 0) {
        calcMsgEl.textContent = "目前尚未達到任何特休級距。";
      } else {
        const highest = determineBracketByMonths(monthsCount);
        calcMsgEl.textContent =
          `目前有效月份為 ${monthsCount} 個月，已達「${highest.label}」級距（僅為依工時換算之概算結果）。`;

        for (const text of lines) {
          const div = document.createElement("div");
          div.className = "summary-row";
          div.textContent = text;
          resLegalListEl.appendChild(div);
        }
      }
    });

    function resetResultDisplay() {
      document.getElementById("calc-message").textContent =
        "尚未計算，請輸入到職日與每月工時後，按下「開始計算」。";
      document.getElementById("res-period").textContent = "—";
      document.getElementById("res-period-months").textContent = "—";
      document.getElementById("res-total-hours").textContent = "—";
      document.getElementById("res-seniority").textContent = "—";
      document.getElementById("res-legal-list").innerHTML = "";
    }

    // 匯出 Excel
    document.getElementById("btn-export").addEventListener("click", () => {
      if (hoursData.length === 0) {
        alert("尚未有任何每月工時資料，無法匯出。");
        return;
      }

      if (!confirm("建議先按「開始計算」更新試算結果，再匯出。是否繼續匯出？")) {
        return;
      }

      const validRows = hoursData.filter(r => typeof r.hours === "number" && !isNaN(r.hours));
      const monthsCount = validRows.length;
      const totalHours = validRows.reduce((sum, r) => sum + r.hours, 0);

      const hireY = parseInt(hireYearSel.value, 10);
      const hireM = parseInt(hireMonthSel.value, 10);
      const hireD = parseInt(hireDaySel.value, 10);
      const hireDate = makeDateFromYMD(hireY, hireM, hireD);

      const lines = monthsCount >= 6
        ? getLegalSummaryLines(monthsCount, totalHours, hireDate)
        : [];

      const header = ["年", "月", "當月工時（小時）"];
      const rows = [...hoursData]
        .sort((a, b) => (b.year - a.year) || (b.month - a.month))
        .map(r => [r.year, r.month, r.hours]);

      const wsData = [header, ...rows];

      wsData.push([]);
      wsData.push(["試算摘要"]);

      // 任職區間（同畫面顯示邏輯）
      if (validRows.length > 0) {
        const sorted = [...validRows].sort((a, b) =>
          (a.year - b.year) || (a.month - b.month)
        );
        const first = sorted[0];
        const last = sorted[sorted.length - 1];
        const startDate = makeDateFromYMD(first.year, first.month, 1);
        const endDate = makeDateFromYMD(last.year, last.month, 1);
        wsData.push(["任職區間", `${formatDate(startDate)} ~ ${formatDate(endDate)}`]);
      } else {
        wsData.push(["任職區間", "—"]);
      }

      const years = Math.floor(monthsCount / 12);
      const months = monthsCount % 12;

      wsData.push(["有效月份數", monthsCount]);
      wsData.push(["累計總工時", totalHours.toFixed(1)]);
      wsData.push(["累計年資（年/月）", `${years} 年 ${months} 月`]);

      wsData.push([]);
      wsData.push(["法定特休計算"]);

      if (monthsCount < 6) {
        wsData.push(["有效月份未滿 6 個月，無特休（僅為概算參考）。"]);
      } else if (lines.length === 0) {
        wsData.push(["目前尚未達到任何特休級距。"]);
      } else {
        for (const text of lines) {
          wsData.push([text]);
        }
      }

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "時薪特休試算");

      const sid = document.getElementById("student-id").value.trim() || "noid";
      const fileName = `hourly_leave_${sid}_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

  </script>
</body>
</html>
