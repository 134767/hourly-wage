btnCalc.addEventListener('click', function () {
  const hireYear = hireYearSelect.value;
  const hireMonth = hireMonthSelect.value;
  const hireDay = hireDayHidden.value || "01"; // 固定 1 號

  const trs = rowsBody.querySelectorAll('tr');
  const rows = [];
  trs.forEach(tr => {
    const year = tr.querySelector('input[name="year"]').value;
    const month = tr.querySelector('select[name="month"]').value;
    const hours = tr.querySelector('input[name="hours"]').value;
    if (year || hours) {
      rows.push({ year, month, hours });
    }
  });

  if (!rows.length) {
    alert('請至少新增一列有效的資料');
    return;
  }

  let totalHours = 0;
  let minDate = null;
  let maxDate = null;

  rows.forEach(r => {
    const y = Number(r.year);
    const m = Number(r.month) - 1;
    const h = Number(r.hours) || 0;
    if (!y || isNaN(y) || m < 0 || m > 11) return;

    const d = new Date(y, m, 1);
    totalHours += h;

    if (!minDate || d < minDate) minDate = d;
    if (!maxDate || d > maxDate) maxDate = d;
  });

  if (!minDate || !maxDate) {
    resultArea.textContent = '年月資料有誤，請確認年/月欄位';
    return;
  }

  const periodEnd = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);

  let output = "";
  output += `資料期間：${fmtDate(minDate)} ~ ${fmtDate(periodEnd)}\n`;
  output += `共有月份筆數：${rows.length}\n\n`;
  output += `全部登記工時總和：${totalHours} 小時\n`;

  // 若未填到職年／月 → 僅顯示工時統計
  if (!hireYear || !hireMonth) {
    output += `\n（尚未輸入到職「年 / 月」→ 僅顯示工時統計）`;
    resultArea.textContent = output;
    return;
  }

  // 組成到職日（yyyy-mm-01）
  const hireDateStr = `${hireYear}-${hireMonth}-${hireDay}`;
  const hireDate = new Date(hireDateStr);
  if (isNaN(hireDate.getTime())) {
    output += `\n到職年月格式錯誤，無法計算特休。`;
    resultArea.textContent = output;
    return;
  }

  // ⭐⭐⭐ 年資終點改為今天（不是最後工時月份）⭐⭐⭐
  const today = new Date();
  const totalMonths = diffInMonths(hireDate, today);
  if (totalMonths < 0) {
    output += `\n到職日晚於今日，請確認。`;
    resultArea.textContent = output;
    return;
  }

  const years = Math.floor(totalMonths / 12);
  const monthsRemainder = totalMonths % 12;
  const legalDays = getLegalDaysByMonths(totalMonths);

  const FULL_YEAR_HOURS = 2088;
  const HALF_YEAR_HOURS = 1044;
  let baseHours = (years === 0 && totalMonths >= 6 && totalMonths < 12)
    ? HALF_YEAR_HOURS
    : FULL_YEAR_HOURS;

  let leaveHours = (legalDays > 0)
    ? totalHours / baseHours * 8 * legalDays
    : 0;

  output += `\n到職日（系統預設為當月1日算起）：${fmtDate(hireDate)}\n`;

  // ⭐⭐⭐ 加入年資區間提示 ⭐⭐⭐
  output += `年資計算區間：${fmtDate(hireDate)} ~ ${fmtDate(today)}（未登記工時月份亦計入年資）\n`;

  output += `累計年資：${years} 年 ${monthsRemainder} 個月（共 ${totalMonths} 月）\n`;
  output += `法定特休日數：${legalDays} 日\n`;
  output += `基準總工時：${baseHours} 小時\n\n`;
  output += `部分工時特休時數：約 ${leaveHours.toFixed(2)} 小時`;

  resultArea.textContent = output;
});
